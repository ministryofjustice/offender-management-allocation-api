ruby_image: &ruby_image
  image: circleci/ruby:2.5.1
  environment:
    RAILS_ENV: test
    PG_HOST: 127.0.0.1
    PG_USER: ubuntu
    RACK_ENV: test

postgres_image: &postgres_image
  image: circleci/postgres:10.5-alpine
  environment:
    POSTGRES_USER: ubuntu
    POSTGRES_PASSWORD: ""
    POSTGRES_DB: allocation-api_test

defaults: &defaults
  working_directory: ~/repo

version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - <<: *ruby_image
      - <<: *postgres_image
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Which bundler?
          command: bundle -v
      - restore_cache:
          keys:
            - allocation-api-v1-{{ checksum "Gemfile.lock" }}
            - allocation-api-v1-
      - run: bundle check --path vendor/bundle || bundle install --path vendor/bundle
      - save_cache:
          key: allocation-api-v1-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/repo/vendor/bundle
      - persist_to_workspace:
          root: .
          paths: vendor/bundle
      - run:
          name: Migrate database
          command: |
            bundle exec rake db:create db:schema:load --trace
            bundle exec rake db:migrate

  test:
    <<: *defaults
    docker:
      - <<: *ruby_image
      - <<: *postgres_image
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run: bundle --path vendor/bundle
      - run:
          name: Download Code Climate
          command: |
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
      - run: |
          ./cc-test-reporter before-build
          bundle exec rake
          ./cc-test-reporter after-build --coverage-input-type simplecov --exit-code $?
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage

  security-static-analysis:
    <<: *defaults
    docker:
      - <<: *ruby_image
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run: bundle --path vendor/bundle
      - run: bundle exec brakeman -o ~/test-results/brakeman/brakeman.json -o ~/test-results/brakeman/brakeman.html
      - store_artifacts:
          path: ~/test-results



workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
      - security-static-analysis:
          requires:
            - build

